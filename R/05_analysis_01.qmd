```{r}
library("tidyverse")
library("patchwork")
library("broom")
library("purrr")

```

```{r}
cancer_data <- read_csv("../data/03_dat_aug_1.csv")
cancer_data |> select(3:14) |>
  pivot_longer(cols = -cancer_type_number,
               names_to = "gene",
               values_to = "expr") |>
  ggplot(aes(x = gene, y = expr)) + geom_boxplot()
```


```{r}

cancer_data_rescaled <- read_csv("../data/03_dat_aug_2.csv")
cancer_data_rescaled |> select(3:14) |>
  pivot_longer(cols = -cancer_type_number,
               names_to = "gene",
               values_to = "expr") |>
  ggplot(aes(x = gene, y = expr)) + geom_boxplot()


```

```{r}
cancer_data_long <- cancer_data_rescaled |>
  select(!c(cancer, ID)) |> 
  pivot_longer(cols = -cancer_type_number,
               names_to = "gene",
               values_to = "expr") 

```

```{r}
#
cancer_data_long_nested <- cancer_data_long |>
  group_by(gene) |>
  nest() |>
  mutate(model_object = map(.x = data,
      .f = ~lm(formula = expr ~ cancer_type_number,
      data = .x)))



```



```{r}
#
cancer_data_long_nested <- cancer_data_long_nested |>
  mutate(model_object_tidy = map(.x = model_object,
                                 .f = ~tidy(x = .x,
                                            conf.int = TRUE,
                                            conf.level = 0.95)))

```

```{r}
#
cancer_data_estimates <- cancer_data_long_nested |>
  unnest(model_object_tidy)
remove(cancer_data_long_nested)
```


```{r}
cancer_data_estimates <- cancer_data_estimates |>
  filter(term == "cancer_type_number") |>
  select(gene, p.value, estimate, conf.low, conf.high) |>
  ungroup()


```

```{r}
cancer_data_estimates <- cancer_data_estimates |>
  mutate(q.value = p.adjust(p = p.value, method = p.adjust.methods)) |>
  mutate(is_significant = case_when(
    q.value > 0.05 ~ "no",
    q.value <= 0.05 ~ "yes")) |>
  mutate(is_significant = factor(is_significant,
                            levels =  c("no", "yes")))
```

```{r}
forest_plot <- cancer_data_estimates |>
  filter(is_significant == "yes") |>
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_errorbarh() +
  geom_point() +
  labs(title = "Gene expression diff between cancers",
       x = "Estimates (95% CIs)",
       y = "Gene") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6.5), plot.title.position = "plot") +
  geom_vline(xintercept = 0)
forest_plot
```

```{r}

heatmap_from_data <- function(estimates_df, tidy_data_df, top = TRUE) {
  if (isTRUE(top)) {
    sig_list <- estimates_df |>
      filter(is_significant == "yes") |>
      slice_max(estimate, n = 25) |>
      select(gene) |>
      pull() |>
      as.character()
  } else {
    sig_list <- estimates_df |>
      filter(is_significant == "yes") |>
      slice_min(estimate, n = 25) |>
      select(gene) |>
      pull() |>
      as.character()
  }
  
  
  cancer_data_rescaled_sig <- tidy_data_df |> 
    select(ID, cancer, all_of(sig_list)) |>
    arrange(cancer)
  cancer_data_rescaled_sig$ID <- factor(cancer_data_rescaled_sig$ID, 
                                          levels = cancer_data_rescaled_sig$ID)
    
    
  heatmap <- cancer_data_rescaled_sig |>
    pivot_longer(cols = -c(ID, cancer), names_to = "gene", values_to = "expr") |>
    ggplot(aes(x = gene, y = ID)) +
    geom_tile(aes(fill=expr)) +
    scale_fill_viridis_c() +
    theme(axis.text.x = element_text(angle=45, hjust = 1, size = 5),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "bottom") +
    facet_grid(vars(cancer), space = "free_y", scales = "free_y")
  
  return(heatmap)
}

heatmap <- heatmap_from_data(cancer_data_estimates, cancer_data_rescaled, TRUE)
heatmap2 <- heatmap_from_data(cancer_data_estimates, cancer_data_rescaled, FALSE)
combined_heatmap <- heatmap + heatmap2

ggsave(filename = "05_key_plot_1.png", plot = heatmap, device = "png", path = "../results")
ggsave(filename = "05_key_plot_2.png", plot = heatmap2, device = "png", path = "../results")
ggsave(filename = "05_key_plot_3.png", plot = combined_heatmap, device = "png", path = "../results")


```